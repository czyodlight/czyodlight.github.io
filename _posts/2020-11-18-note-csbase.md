---
layout: post
title: 计算机网络基础
date: 2020-11-18
Author: halin
tag: [note,document]
conmment: false
toc: true

---
计算机网络基础学习笔记
<!-- more -->
## 一些基础概念

- 物理层中继系统：转发器 (repeater)。
  数据链路层中继系统：网桥 或 桥接器 (bridge)。
- 网络层中继系统：路由器 (router)。
  网桥和路由器的混合物：桥路器 (brouter)。
- 网络层以上的中继系统：网关 (gateway)

- 网络互连是指用路由器进行网络互连和路由选择
- 由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关。   

## 物理层

**为比特流在物理层传输提供服务**
-  **术语**

   - 数据 (data) —— 运送消息的实体。
    - 信号 (signal) —— 数据的电气的或电磁的表现。 
    - 模拟信号 (analogous signal) —— 代表消息的参数的取值是连续的。 
    - 数字信号 (digital signal) —— 代表消息的参数的取值是离散的。
    -  基带信号（即基本频带信号）—— 来自信源的信号。像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号。
    - 码元 (code) —— 在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。
    - 信道 —— 一般用来表示向某一个方向传送信息的媒体。
    - 单向通信（单工通信）——只能有一个方向的通信而没有反方向的交互。
    - 双向交替通信（半双工通信）——通信的双方都可以发送信息，但不能双方同时发送(当然也就不能同时接收)。
    - 双向同时通信（全双工通信）——通信的双方可以同时发送和接收信息。 

- **调制**:

  - 基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。因此必须对基带信号进行调制 

  - 基带调制：仅对基带信号的波形进行变换，使它能够与信道特性相适应。变换后的信号仍然是基带信号。把这种过程称为编码 (coding)。

  - 带通调制：使用载波 (carrier)进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号，这样就能够更好地在模拟信道中传输（即仅在一段频率范围内能够通过信道） 。

    ![带通调制](/images/ImageOfNet/带通调制.png)

  - 带通信号 ：经过载波调制后的信号。

- **编码**（基带调制）

    ![常见编码方式](/images/ImageOfNet/常见编码方式.png)
    - 不归零制：正电平代表 1，负电平代表 0。
    - 归零制：正脉冲代表 1，负脉冲代表 0。
    - 曼彻斯特编码：位周期中心的向上跳变代表 0，位周期中心的向下跳变代表 1。但也可反过来定义。
    - 差分曼彻斯特编码：在每一位的中心处始终都有跳变。位开始边界有跳变代表 0，而位开始边界没有跳变代表 1。

- 计算

  - 信噪比(dB) = 10 log10(S/N)    (dB) 
  - C = W log2(1+S/N)    (bit/s) 
    其中：W 为信道的带宽（以 Hz 为单位）；
    		S 为信道内所传信号的平均功率；
    		N 为信道内部的高斯噪声功率。
    		
### 信道复用技术

  - 频分复用、时分复用和统计时分复用

  - 波分复用

  - 码分复用（CDMA）:

    - 每个站都有不同且互相正交的码片，码片序列表示1，反码表示0

    - 任意不同两个站码片

      $$\mathbf{S} \bullet \mathbf{T} \equiv \frac{1}{m} \sum_{i=1}^{m} S_{i} T_{i}=0$$

    - 向量与自身规格化内积都是 1 

      $$\mathbf{S} \bullet \mathbf{S}=\frac{1}{m} \sum_{i=1}^{m} S_{i} S_{i}=\frac{1}{m} \sum_{i=1}^{m} S_{i}^{2}=\frac{1}{m} \sum_{i=1}^{m}(\pm 1)^{2}=1$$

      

## 数据链路层

**为相邻结点间的通信提供服务**

**将IP数据报打包成帧**

- **分层**
  - LLC：逻辑链路控制，看不到局域网
  - MAC：媒体接入控制，和物理层组成局域网

- **三个基本问题**：
  - 封装成帧：添加首部SOH和尾部EOT确定帧的界限
  - 透明传输：对IP数据报不会错误识别成SOH或EOT，采用字节填充或字符填充解决
  - 差错控制 ：传输过程数据丢失或错误，使用循环冗余建议CRC解决，在数据后面添加冗余码FCS
  
- 

### 以太网

  - 特点：
    - 无连接的工作方式
    - 使用曼彻斯特编码
  - 以广播方式发送：局域网内每一台主机都能检测到B发送信号，只有D检测到B数据帧头部地址一致才接受，其他主机则丢弃。广播特性的总线上实现了一对一的通信

- **CSMA/CD碰撞检测协议**

  - 发送前先监听，边发送边监听，一旦发现总线上出现了碰撞，就立即停止发送。然后按照退避算法等待一段随机时间后再次发送。因此，每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。以太网上各站点都平等地争用以太网信道。

- **以太网MAC层**

  ![以太网MAC帧格式](/images/ImageOfNet/以太网MAC帧格式.png)

  - 硬件地址（MAC地址）：48位全网唯一
  - MAC 帧长不小于 64 字节，在64 ~ 1518 字节之间
  - 检测出错直接丢弃

- **以太网拓展**

  - 使用集线器的以太网：集线器工作在物理层，它的每个接口仅仅简单地转发比特，不进行碰撞检测。
  - 以太网交换机工作在数据链路层。
  - 以太网交换机能同时连通许多对的接口，使每一对相互通信的主机都能像独占通信媒体那样，无碰撞地传输数据。

- **知识点**

  - 计算机的硬件地址就在适配器的ROM中。
  - 以太网采用广播通信方式发送数据：如何在具有广播特性的总线上实现一对一的通信？
  - 以太网采用无连接的工作方式，对发送的数据帧不进行编号，也不要求对方发回确认。
  - 以太网提供的服务是不可靠的交付。目的站收到有差错帧就把它丢弃，其他什么也不做。差错的纠正由高层来决定

## 网络层

**为Internet上不同主机通信提供服务**

抽象为主机->网络->主机

![IP数据报](/images/ImageOfNet/IP数据报.png)

- 提供服务特征：
  - 无连接（分组独立发送，没有逻辑连接）
  - 尽最大努力交付（不提供服务质量承诺）
  - 简单灵活

### 网际协议IP

  - 配套协议：

    - 地址解析协议ARP
      （Address Resolution Protocol）
    - 网际控制报文协议ICMP
      （Internet Control Message Protocol）
    - 网际组管理协议IGMP
      （Internet Group Management Protocol）

  - IP地址：

    - IP 地址是全世界范围是唯一的 32 位的标识符。
    - IP 地址现在由互联网名字和数字分配机构ICANN (Internet Corporation for Assigned Names and Numbers)进行分配。 
    - 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id。
    - 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。
    
  - 分类IP地址

    ![分类编址](/images/ImageOfNet/分类编址.png)

    ![特殊IP地址](/images/ImageOfNet/特殊IP地址.png)

    - 每类地址都分为两部分，网络号和主机号
    - A类前一个字节为网络号，后三字节为主机号，0开头 ，1-126
    - B类前两个字节为网络号，后两个字节为主机号，10开头，128.1-191.255
    - C类前三个字节为网络号，后一个字节为主机号，110开头，192.0.1-233.255.255
    - D类为多播地,1110开头224
    - E类地址保留今后使用，1111开头240

  - IP数据报

    ![IP数据报格式](/images/ImageOfNet/IP数据报格式.png)

    - 格式：首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。后面是一些可选字段，其长度是可变的。 

    - 版本：占 4 位，指 IP 协议的版本。目前的 IP 协议版本号为 4 (即 IPv4)。

    - 首部长度：占 4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节

    - 总长度:占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。但总长度不超过MTU

    - 标识(identification) ：占 16 位，它是一个计数器，用来产生 IP 数据报的标识,即作记号

    - 标志(flag) :占 3 位，目前只有前两位有意义。

      ​	标志字段的最低位是 MF (More Fragment)。

      ​		MF = 1 表示后面“还有分片”。   	

      ​		MF = 0 表示最后一个分片。

      ​	标志字段中间的一位是 DF (Don't Fragment) 。

      ​	只有当 DF = 0 时才允许分片。

    - 片偏移:占13 位，指出：较长的分组在分片后数据部分某片在原分组中的相对位置。片偏移以8 个字节为偏移单位。 若数据部分分成1400,1400,1000字节，那么数据片1偏移=0/8,2偏移=1400/8,3偏移2800/8

    - 生存时间：占8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值。经过一个路由器TTL-1

    - 协议：占8 位，指出此数据报携带的数据使用何种协议

    - 分片：
      - 当原始IP数据报大于MTU时需要分片，把数据部分分割再加上首部，使总长度小于等于MTU
      - 原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值（偏移量，flag，identification）。

### 分类IP下的网络层数据流过程

一台主机IP数据报如何通过路由器转发到另一台主机

  - 流程：主机发送数据报给路由器，路由器根据目的IP地址转发，直到目的主机
  - 路由器转发依赖路由器表中的目的主机所在网络和下一跳地址。路由器并没有目的地址和源地址之间完整路径。只知道到下一步应该到达哪一个路由器，再根据下一个路由器表跳转，直到跳转到目的IP网络
  - 路由器至少有两个IP地址，因为需要从一个网络转发到另一个网络
  - 路由器转发算法：
    1. 从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络为 N。
    2.  若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D
    3. 若路由表 有D 的特定主机路由，则把数据报传送给路由表
    4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器
    5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器 
    6. 否则 报告转发分组出错。 
  - 特定主机路由器：路由器表中为一个IP地址有绑定一个下一跳路由器
  - 默认路由器：路由器表的默认下一跳路由

### 划分子网

  ![划分子网](/images/ImageOfNet/划分子网.png)

  - 由二级IP地址变三级IP地址。
  - IP地址由网络号，子网号，主机号构成。
  - 只对原二级网中主机号进行划分，并不改变原来网络号，子网只是内部单事情，在单位外看不到有多少个子网任表现为一个网络。
  - 划分方法：像二级网一样固定长度或者变长方法。
  - 子网掩码：网络号和子网号和1进行与运算，主机号与0进行与运算。
  - 优缺点：增加了灵活性，但却减少了能够连接在网络上的主机总数

### 划分子网下的路由转发

  - 其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。最后就将 IP 数据报直接交付目的主机。 
  - 加入子网后路由表必须包含以下三项内容:目的网络地址、 子网掩码和下一跳地址。 
  - 算法：
    1. 从收到的数据报的首部提取目的 IP 地址 D。
    2. 先判断是否为直接交付。对路由器直接相连的网络（同一子网，路由器有多个IP地址即同时在几个子网，）逐个进行检查:用各网络的子网掩码和 D 逐位相"与" (AND 操作)，看结果是否和相应的网络地址匹配。若匹配，则把分组进行直接交付(当然还需要把 D 转换成物理地址，把数据报封装成帧发送出去)，转发任务结束。否则就是间接交付. 
    3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器。
    4.  对路由表中的每一行(目的网络地址，子网掩码，下一跳地址) ，用其中的子网掩码和 D 逐位相"与" (AND 操作)，其结果为 N。若 N 与该行的目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器。
    5.  若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器。
    6. 报告转发分组出错。

- 无分类编址CIDR：

  ![无分类编址](/images/ImageOfNet/无分类编址.png)

  - 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念。CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。前缀称为CIRD地址块
  - 从三级编址回到二级编址。
  - IP地址由网络前缀，主机号构成。使用斜线记法：IP/网络前缀位数，如：128.14.32.0/20，共有$2^{12}$个地址。20也表示掩码是20个连续1.
  - 全 0 和全 1 的主机号地址一般不使用
  - 一个地址块包含多个（分类地址）网络号，这些地址称为路由器聚合也称为超网。如64.1.0.1/6包含3个A类网，1.\*，2.\*，3.*即0100 0001 , 0100 0002 ，0100 0003。
  - 路由转发：选择最长前缀匹配，因为最长匹配所在网络越小，路由越具体。
  - 为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找。这里最常用的就是二叉线索(binary trie)。

## 运输层

**运输层为两台主机之间的进程通信提供服务**

- **运输层两个主要协议**：
  
  - udp（用户数据报）：无连接协议
    - 在传送数据之前不需要先建立连接
  - TCP（TCP报文段）： 面向连接协议
    - 不提供广播或多播服务
  - 提供可靠的、面向连接的运输服务
  
- **端口**

  运输层使用端口对IP进行复用和分用

  ![常知端口](/images/ImageOfNet/常知端口.png)

  - 用16 位端口号进行标志
  - 端口号只具有本地意义，即端口号只是为了标志本计算机应用层中的各进程。
  - 服务器端使用的端口号
    1. 熟知端口，数值一般为 0~1023。
    2. 登记端口号，数值1024~49151，为没有熟知端口号的应用程序使用的。使用这个范围的端口号必须在 IANA 登记，以防止重复。
  - 客户端使用的端口号:
    又称为短暂端口号，数值为 49152~65535，留给客户进程选择暂时使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可供其他客户进程以后使用。 

### UDP协议

  ![UDP首部和伪首部](/images/ImageOfNet/UDP首部和伪首部.png)

  - **特点**：
    1.  UDP 是无连接的
    2. UDP 使用尽最大努力交付
    3. UDP 是面向报文的。应用层交给 UDP 多长的报文，UDP 就照样发送，既不合并，也不拆分，而是保留这些报文的边界。即一次发送一个报文，应用程序必须选择合适大小的报文，否则降低IP层效率
    4.  伪首部用于检验和
    5.  UDP 没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。很适合多媒体通信的要求。
    6.  UDP 支持一对一、一对多、多对一和多对多的交互通信。
    7.  UDP 首部只有 8 个字节，比 TCP 的 20 个字节的首部要短。

### TCP协议

  - **特点**：

    1. TCP 是面向连接的运输层协议。

    2. 每一条 TCP 连接只能有两个端点 (endpoint)，每一条 TCP 连接只能是点对点的（一对一）。 

    3. TCP 提供可靠交付的服务。

    4. TCP 提供全双工通信。

    5. 面向字节流,TCP 对连续的字节流进行分段，形成 TCP 报文段。

       ![TCP面向字节流概念](/images/ImageOfNet/TCP面向字节流概念.png)

  - **注意**：

    1. TCP 连接是一条虚连接
    2. TCP 对应用进程一次把多长的报文发送到TCP 的缓存中是不关心的。
    3. TCP 根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）。
    4. TCP 可把太长的数据块划分短一些再传送。
    5. TCP 也可等待积累有足够多的字节后再构成报文段发送出去。

  - **套接字(socket)**

    ![TCP套接字](/images/ImageOfNet/TCP套接字.png)

    -  TCP将每一条连接抽象，TCP连接有两个端点，端点叫套接字或插口

  - **问题**：
    
    - 无法保证传输信道不产生差错。
    - 无法保证不管发送方以多快的速度发送数据，接收方总是来得及处理收到的数据。
  - 通过一些可靠传输协议，在不可靠的传输信道实现可靠传输，停止等待协议和连续ARQ协议
    
  - **停止等待协议**

    发送完一个分组就停止发送，等待对方的确认。在收到确认后再发送下一个分组，简单但利用率低。

    ![停止等待协议信道利用率](/images/ImageOfNet/停止等待协议信道利用率.png)

    - 发送方为每一个已发送分组设置一个超时计时器，以确保发送过程不会出错。
    - 接收方确定丢失和确定迟到，接收方收到新的分组后丢弃旧分组，向发送方发送确定
    - 注意：
      1. 在发送完一个分组后，必须暂时保留已发送的分组的副本，以备重发。
      2. 分组和确认分组都必须进行编号。
      3. 超时计时器的重传时间应当比数据在分组传输的平均往返时间更长一些。 

  - **连续ARQ协议**

    ![流水传输](/images/ImageOfNet/流水传输.png)

    ![ARQ工作原理](/images/ImageOfNet/ARQ工作原理.png)

    - **工作原理**：位于发送窗口内的分组都可连续发送出去，而不需要等待对方的确认。发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置
    - **累计确认**：接收方一般采用累积确认的方式。即对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了，缺点：不能正确反映所有分组正确接受
    - **回退N**：如果发送方发送了前 5 个分组，而中间的第 3 个分组丢失了。这时接收方只能对前两个分组发出确认。发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次。
    
  - **TCP具体实现**

    - TCP 连接的每一端都必须设有两个窗口，一个发送窗口和一个接收窗口。
    - TCP 的可靠传输机制用字节的序号进行控制。TCP 所有的确认都是基于序号而不是基于报文段。
    - TCP 两端的四个窗口经常处于动态变化之中。
    - TCP连接的往返时间 RTT 也不是固定不变的。需要使用特定的算法估算较为合理的重传时间。  

  - **TCP首部格式**

    ![TCP首部格式](/images/ImageOfNet/TCP首部格式.png)

    - MSS (Maximum Segment Size)：
      是 TCP 报文段中的数据字段的最大长度。
      MSS是“TCP 报文段长度减去 TCP 首部长度”，放在选项字段，告诉对方我能接受最大长度。
  - 紧急 URG ： 当 URG = 1 时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)。
    - 确认 ACK ：只有当 ACK = 1 时确认号字段才有效。当 ACK = 0 时，确认号无效。 
    - 推送 PSH (PuSH) ： 接收 TCP 收到 PSH = 1 的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付。 
    - 复位 RST (ReSeT) ：当 RST = 1 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。
    - 同步 SYN ：同步 SYN = 1 表示这是一个连接请求或连接接受报文。 
    - 终止 FIN (FINish) ：用来释放一个连接。FIN = 1 表明此报文段的发送端的数据已发送完毕，并要求释放运输连接。 
    
  - **缓存**

    - 发送缓存用来暂时存放：
      - 发送应用程序传送给发送方 TCP 准备发送的数据；
      - TCP 已发送出但尚未收到确认的数据。
    - 接收缓存用来暂时存放：
      - 按序到达的、但尚未被接收应用程序读取的数据；
      - 不按序到达的数据。 

  - **强调**
    - A 的发送窗口并不总是和 B 的接收窗口一样大（因为有一定的时间滞后）。
    - TCP 标准没有规定不按序到达的数据应如何处理。通常是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程。
    - TCP 要求接收方必须有累积确认的功能，这样可以减小传输开销。  

  - **RTT、RTO**

    - 往返时间

      $$newRTT_S=(1-a)*oldRTT_S+a*RTT$$

      RTTs是加权平均往返时间，RTT是每次记录的往返时间，RTTs不断更新，a推荐值为1/8

    - 超时重传

      $$RTO =RTTs + 4*RTTd$$

      $$newRTTd = (1 -b) *(old RTTd) +b*|RTTs - new RTT|$$

      RTTd是RTT的偏差的加权平均值,b推荐值1/4

    - 修正Karn算法

      karn算法不计算重传RTT，造成系统延迟变大超过旧重传时间，就会不断重传，但RTT无法更新。

      修正：报文段每重传一次，就把 RTO 增大一些,新的RTO=y*（旧的RTO）,y典型值为2

  - **选择确认 SACK**

    未按序号到达的接收方就先收下这些数据，但要把这些信息准确地告诉发送方，使发送方不要再重复发送这些已收到的数据。

  - **流量控制和拥塞控制**
    - 前者通过滑动窗口达到流量控制
    - 后者是取决整个网络，TCP基于拥塞窗口进行拥塞控制，
    - 真正的发送窗口值=Min（公告窗口值，拥塞窗口值）；发送方让自己的发送窗口取为拥塞窗口和接收方的接收窗口中较小的一个。
- TCP 的拥塞控制采用了四种算法：慢开始、拥塞避免、快重传、快恢复
  
- **连接建立和断开**
  
  - 建立（三次握手）：
  
    ![三次握手](/images/ImageOfNet/三次握手.png)
  
  - 断开（四次握手）
  
      ![四次握手](/images/ImageOfNet/四次握手.png)

